<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.edoc.clsf.domain.repository.DocClsfMapper">
	
	<resultMap id="docClsf" type="egovframework.com.edoc.clsf.domain.model.DocClsfVO">
		<result column="doc_clsf_no" property="docClsfNo"/>
		<association property="prvcFileHldPrst" column="doc_clsf_no" select="egovframework.com.edoc.clsf.domain.repository.PrvcFileHldPrstMapper.select" />
	</resultMap>
	
	<sql id="fields">
		dc.doc_clsf_no, 
		dc.doc_clsf_se_cd, 
		dc.doc_clsf_nm, 
		dc.up_doc_clsf_no, 
		dc.prvc_incl_yn, 
		dc.use_en, 
		dc.reg_ymd, 
		dc.rgtr_id, 
		dc.mdfcn_ymd, 
		dc.mdfr_id,
		dcnm.doc_lclsf_no,
		dcnm.doc_mclsf_no,
		dcnm.doc_sclsf_no,
		dcnm.doc_lclsf_nm,
		dcnm.doc_mclsf_nm,
		dcnm.doc_sclsf_nm
	</sql>
	
	<sql id="fromTables">
		tb_dr_m_doc_clsf AS dc
		LEFT JOIN 
		(WITH RECURSIVE cte(doc_clsf_no, doc_clsf_se_cd, up_doc_clsf_no, doc_clsf_no_arr, doc_clsf_nm_arr) AS (
			SELECT t.doc_clsf_no, t.doc_clsf_se_cd, t.up_doc_clsf_no, CAST(ARRAY[t.doc_clsf_no] AS text[]) AS doc_clsf_no_arr, CAST(ARRAY[t.doc_clsf_nm] AS text[]) AS doc_clsf_nm_arr FROM tb_dr_m_doc_clsf AS t 
			UNION ALL
			SELECT cte.doc_clsf_no, p.doc_clsf_se_cd, p.up_doc_clsf_no, cte.doc_clsf_no_arr || p.doc_clsf_no, cte.doc_clsf_nm_arr || p.doc_clsf_nm FROM tb_dr_m_doc_clsf AS p JOIN cte ON p.doc_clsf_no=cte.up_doc_clsf_no
			) 
		SELECT cte.doc_clsf_no,  doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)] AS doc_lclsf_no, doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)-1] AS doc_mclsf_no, doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)-2] AS doc_sclsf_no, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)] AS doc_lclsf_nm, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)-1] AS doc_mclsf_nm, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)-2] AS doc_sclsf_nm FROM cte WHERE cte.doc_clsf_se_cd='L'
		) AS dcnm ON dc.doc_clsf_no=dcnm.doc_clsf_no
	</sql>
	
	
    
    <insert id="insert" >
        INSERT INTO tb_dr_m_doc_clsf
			(doc_clsf_no, doc_clsf_se_cd, doc_clsf_nm, up_doc_clsf_no, prvc_incl_yn, use_en, reg_ymd, rgtr_id, mdfcn_ymd, mdfr_id)
		VALUES
			(#{docClsfNo}, #{docClsfSeCd}, #{docClsfNm}, #{upDocClsfNo}, #{prvcInclYn}, #{useEn}, NOW(), #{rgtrId}, NOW(), #{mdfrId})
    </insert>

	<update id="update">
		UPDATE tb_dr_m_doc_clsf
		SET
			doc_clsf_nm = #{docClsfNm},
			prvc_incl_yn = #{prvcInclYn},
			use_en = #{useEn},
			mdfr_id = #{mdfrId},
			mdfcn_ymd = NOW()
		WHERE
			doc_clsf_no = #{docClsfNo}
	</update>
		


	<select id="select" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_no = #{docClsfNo}
 		
 	</select>

	<select id="selectListByDocClsfSeCd" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_se_cd = #{docClsfSeCd}
 		
 	</select>
 	

 	<select id="selectListByUpDocClsfNo" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.up_doc_clsf_no = #{docClsfNo}
 	</select> 	 	

 	<select id="selectList" parameterType="egovframework.com.edoc.clsf.dto.request.DocClsfSearchRequestDto" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			1=1
			<if test="docLclsfNo != null and docLclsfNo != ''">
				AND dcnm.doc_lclsf_no = #{docLclsfNo}
			</if>
			<if test="docMclsfNo != null and docMclsfNo != ''">
				AND dcnm.doc_mclsf_no = #{docMclsfNo}
			</if>
			<if test="docSclsfNo != null and docSclsfNo != ''">
				AND dcnm.doc_sclsf_no = #{docSclsfNo}
			</if>
			<if test="docClsfNm != null and docClsfNm != ''">
				AND (
				 	dcnm.doc_lclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				 		OR
				 	dcnm.doc_mclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				 		OR
				 	dcnm.doc_sclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				)
			</if>
			<if test="prvcInclYn != null and prvcInclYn != ''">
				AND dc.prvc_incl_yn = #{prvcInclYn}
			</if>
			<if test="useEn != null and useEn != ''">
				AND dc.use_en = #{useEn}
			</if>
 	</select>

	<select id="selectListTotCnt" parameterType="egovframework.com.edoc.clsf.dto.request.DocClsfSearchRequestDto" resultType="int">

			SELECT 
				COUNT(*) totcnt
			FROM
				<include refid="fromTables"/>
			WHERE
				1=1
				<if test="docLclsfNo != null and docLclsfNo != ''">
					AND dcnm.doc_lclsf_no = #{docLclsfNo}
				</if>
				<if test="docMclsfNo != null and docMclsfNo != ''">
					AND dcnm.doc_mclsf_no = #{docMclsfNo}
				</if>
				<if test="docSclsfNo != null and docSclsfNo != ''">
					AND dcnm.doc_sclsf_no = #{docSclsfNo}
				</if>
				<if test="docClsfNm != null and docClsfNm != ''">
					AND (
					 	dcnm.doc_lclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					 		OR
					 	dcnm.doc_mclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					 		OR
					 	dcnm.doc_sclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					)
				</if>
				<if test="prvcInclYn != null and prvcInclYn != ''">
					AND dc.prvc_incl_yn = #{prvcInclYn}
				</if>
				<if test="useEn != null and useEn != ''">
					AND dc.use_en = #{useEn}
				</if>
	</select>
</mapper>