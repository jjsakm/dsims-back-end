<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.edoc.clsf.domain.repository.DocClsfMapper">
	
	<resultMap id="docClsf" type="egovframework.com.edoc.clsf.domain.model.DocClsfVO" autoMapping="true">
		<association property="prvcFileHldPrst" columnPrefix="pfhp_" autoMapping="true"/>
		<!-- <association property="prvcFileHldPrst" column="doc_clsf_no" select="egovframework.com.edoc.clsf.domain.repository.PrvcFileHldPrstMapper.select" /> -->
	</resultMap>
	
	<sql id="fields">
		dc.doc_clsf_no, 
		dc.doc_clsf_se_cd, 
		dc.doc_clsf_nm, 
		dc.up_doc_clsf_no, 
		dc.prvc_incl_yn, 
		dc.use_en, 
		dc.reg_ymd, 
		dc.rgtr_id, 
		dc.mdfcn_ymd, 
		dc.mdfr_id,
		dcnm.doc_lclsf_no,
		dcnm.doc_mclsf_no,
		dcnm.doc_sclsf_no,
		dcnm.doc_lclsf_nm,
		dcnm.doc_mclsf_nm,
		dcnm.doc_sclsf_nm,
		pfhp.doc_clsf_no AS pfhp_doc_clsf_no,
		pfhp.prvc_file_hld_prst_no AS pfhp_prvc_file_hld_prst_no,
		pfhp.dept_nm AS pfhp_dept_nm,
		pfhp.file_nm AS pfhp_file_nm,
		pfhp.hld_prps AS pfhp_hld_prps,
		pfhp.clct_stt_bss_expln AS pfhp_clct_stt_bss_expln,
		pfhp.use_dept_nm AS pfhp_use_dept_nm,
		pfhp.prvc_prcs_mthd_expln AS pfhp_prvc_prcs_mthd_expln,
		pfhp.hld_prd_dfyrs AS pfhp_hld_prd_dfyrs,
		pfhp.hld_prd_mm_cnt AS pfhp_hld_prd_mm_cnt,
		pfhp.info_mnbd_prvc_mttr AS pfhp_info_mnbd_prvc_mttr,
		pfhp.stty_agt_prvc_mttr AS pfhp_stty_agt_prvc_mttr,
		pfhp.rrno_clct_yn AS pfhp_rrno_clct_yn,
		pfhp.rrno_clct_stt_bss_expln AS pfhp_rrno_clct_stt_bss_expln,
		pfhp.info_mnbd_agre_yn AS pfhp_info_mnbd_agre_yn,
		pfhp.info_mnbd_dsag_clct_stt_bss_expln AS pfhp_info_mnbd_dsag_clct_stt_bss_expln,
		pfhp.sens_info_hld_yn AS pfhp_sens_info_hld_yn,
		pfhp.sens_info_indiv_agre_yn AS pfhp_sens_info_indiv_agre_yn,
		pfhp.sens_info_hld_stt_bss_expln AS pfhp_sens_info_hld_stt_bss_expln,
		pfhp.uii_hld_yn, uii_indiv_agre_yn AS pfhp_uii_indiv_agre_yn,
		pfhp.uii_hld_stt_bss_expln AS pfhp_uii_hld_stt_bss_expln,
		pfhp.prvc_evl_trgt_yn AS pfhp_prvc_evl_trgt_yn,
		pfhp.hndl_pic_nm AS pfhp_hndl_pic_nm,
		pfhp.tdpty_splrcp_nm AS pfhp_tdpty_splrcp_nm,
		pfhp.tdpty_pvsn_bss_expln AS pfhp_tdpty_pvsn_bss_expln,
		pfhp.tdpty_pvsn_mttr AS pfhp_tdpty_pvsn_mttr,
		pfhp.prvc_prcs_cnsgn_bzenty_nm AS pfhp_prvc_prcs_cnsgn_bzenty_nm,
		pfhp.prvc_cnsgn_ctrt_yn AS pfhp_prvc_cnsgn_ctrt_yn,
		pfhp.prvc_cnsgn_fact_indct_yn AS pfhp_prvc_cnsgn_fact_indct_yn,
		pfhp.prps_excl_utztn_pvsn_yn AS pfhp_prps_excl_utztn_pvsn_yn,
		pfhp.prps_excl_utztn_pvsn_bss_expln AS pfhp_prps_excl_utztn_pvsn_bss_expln,
		pfhp.reg_ymd AS pfhp_reg_ymd,
		pfhp.rgtr_id AS pfhp_rgtr_id,
		pfhp.mdfcn_ymd AS pfhp_mdfcn_ymd,
		pfhp.mdfr_id AS pfhp_mdfr_id
	</sql>
	
	<sql id="fromTables">
		tb_dr_m_doc_clsf AS dc
		LEFT JOIN 
		(WITH RECURSIVE cte(doc_clsf_no, doc_clsf_se_cd, up_doc_clsf_no, doc_clsf_no_arr, doc_clsf_nm_arr) AS (
			SELECT t.doc_clsf_no, t.doc_clsf_se_cd, t.up_doc_clsf_no, CAST(ARRAY[t.doc_clsf_no] AS text[]) AS doc_clsf_no_arr, CAST(ARRAY[t.doc_clsf_nm] AS text[]) AS doc_clsf_nm_arr FROM tb_dr_m_doc_clsf AS t 
			UNION ALL
			SELECT cte.doc_clsf_no, p.doc_clsf_se_cd, p.up_doc_clsf_no, cte.doc_clsf_no_arr || p.doc_clsf_no, cte.doc_clsf_nm_arr || p.doc_clsf_nm FROM tb_dr_m_doc_clsf AS p JOIN cte ON p.doc_clsf_no=cte.up_doc_clsf_no
			) 
		SELECT cte.doc_clsf_no,  doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)] AS doc_lclsf_no, doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)-1] AS doc_mclsf_no, doc_clsf_no_arr[CARDINALITY(doc_clsf_no_arr)-2] AS doc_sclsf_no, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)] AS doc_lclsf_nm, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)-1] AS doc_mclsf_nm, doc_clsf_nm_arr[CARDINALITY(doc_clsf_no_arr)-2] AS doc_sclsf_nm FROM cte WHERE cte.doc_clsf_se_cd='L'
		) AS dcnm ON dc.doc_clsf_no=dcnm.doc_clsf_no
		LEFT JOIN
			tb_dr_m_prvc_file_hld_prst AS pfhp ON pfhp.doc_clsf_no=dc.doc_clsf_no
		
	</sql>
	
	
    
    <insert id="insert" useGeneratedKeys="true" keyColumn="doc_clsf_no" keyProperty="docClsfNo">
        INSERT INTO tb_dr_m_doc_clsf
			(doc_clsf_no, doc_clsf_se_cd, doc_clsf_nm, up_doc_clsf_no, prvc_incl_yn, use_en, reg_ymd, rgtr_id, mdfcn_ymd, mdfr_id)
		VALUES
			((SELECT 'MDOC' || to_char(NOW(), 'YYYYMMDD') || coalesce(max(substring(doc_clsf_no, 13)::integer)+1, 1) FROM tb_dr_m_doc_clsf WHERE doc_clsf_no LIKE 'MDOC' || to_char(NOW(), 'YYYYMMDD') || '%'), #{docClsfSeCd}, #{docClsfNm}, #{upDocClsfNo}, #{prvcInclYn}, #{useEn}, NOW(), #{rgtrId}, NOW(), #{mdfrId})
    </insert>

	<update id="update">
		UPDATE tb_dr_m_doc_clsf
		SET
			doc_clsf_nm = #{docClsfNm},
			up_doc_clsf_no = #{upDocClsfNo},
			prvc_incl_yn = #{prvcInclYn},
			use_en = #{useEn},
			mdfr_id = #{mdfrId},
			mdfcn_ymd = NOW()
		WHERE
			doc_clsf_no = #{docClsfNo}
	</update>
	
	<delete id="delete">
		DELETE FROM
			tb_dr_m_doc_clsf
		WHERE
			doc_clsf_no = #{docClsfNo}

	</delete>
		


	<select id="select" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_no = #{docClsfNo}
 		
 	</select>

	<select id="selectListByDocClsfSeCd" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_se_cd = #{docClsfSeCd}
 		
 	</select>
 	

 	<select id="selectListByUpDocClsfNo" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.up_doc_clsf_no = #{docClsfNo}
 	</select> 	 	

 	<select id="selectList" parameterType="egovframework.com.edoc.clsf.dto.request.DocClsfSearchRequestDto" resultMap="docClsf">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			1=1
			<if test="docLclsfNo != null and docLclsfNo != ''">
				AND dcnm.doc_lclsf_no = #{docLclsfNo}
			</if>
			<if test="docMclsfNo != null and docMclsfNo != ''">
				AND dcnm.doc_mclsf_no = #{docMclsfNo}
			</if>
			<if test="docSclsfNo != null and docSclsfNo != ''">
				AND dcnm.doc_sclsf_no = #{docSclsfNo}
			</if>
			<if test="docClsfNm != null and docClsfNm != ''">
				AND (
				 	dcnm.doc_lclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				 		OR
				 	dcnm.doc_mclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				 		OR
				 	dcnm.doc_sclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
				)
			</if>
			<if test="prvcInclYn != null and prvcInclYn != ''">
				AND dc.prvc_incl_yn = #{prvcInclYn}
			</if>
			<if test="useEn != null and useEn != ''">
				AND dc.use_en = #{useEn}
			</if>
		ORDER BY
			dcnm.doc_lclsf_no,
			dcnm.doc_mclsf_no NULLS FIRST,
			dcnm.doc_sclsf_no NULLS FIRST
		<!-- LIMIT #{recordCountPerPage} OFFSET #{firstIndex}_ -->
 	</select>

	<select id="selectListTotCnt" parameterType="egovframework.com.edoc.clsf.dto.request.DocClsfSearchRequestDto" resultType="int">

			SELECT 
				COUNT(*) totcnt
			FROM
				<include refid="fromTables"/>
			WHERE
				1=1
				<if test="docLclsfNo != null and docLclsfNo != ''">
					AND dcnm.doc_lclsf_no = #{docLclsfNo}
				</if>
				<if test="docMclsfNo != null and docMclsfNo != ''">
					AND dcnm.doc_mclsf_no = #{docMclsfNo}
				</if>
				<if test="docSclsfNo != null and docSclsfNo != ''">
					AND dcnm.doc_sclsf_no = #{docSclsfNo}
				</if>
				<if test="docClsfNm != null and docClsfNm != ''">
					AND (
					 	dcnm.doc_lclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					 		OR
					 	dcnm.doc_mclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					 		OR
					 	dcnm.doc_sclsf_nm LIKE CONCAT('%', #{docClsfNm}, '%')
					)
				</if>
				<if test="prvcInclYn != null and prvcInclYn != ''">
					AND dc.prvc_incl_yn = #{prvcInclYn}
				</if>
				<if test="useEn != null and useEn != ''">
					AND dc.use_en = #{useEn}
				</if>
	</select>
	
	<sql id="countQuery">
		SELECT 
			COUNT(*)
		FROM
			tb_dr_m_doc_clsf
	</sql>

	<select id="countByDocClsfNm" resultType="int">
		<include refid="countQuery" />
		WHERE
			 doc_clsf_se_cd = #{docClsfSeCd} AND doc_clsf_nm = #{docClsfNm}
	</select>

	<select id="countByDocClsfNmExcludingDocClsfNo" resultType="int">
		<include refid="countQuery" />
		WHERE
			 doc_clsf_se_cd = #{docClsfSeCd} AND doc_clsf_nm = #{docClsfNm} AND doc_clsf_no != #{docClsfNo}
	</select>
</mapper>