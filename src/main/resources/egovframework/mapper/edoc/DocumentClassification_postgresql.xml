<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.com.edoc.clsf.domain.repository.DocumentClassificationMapper">

	<resultMap id="documentClassification" type="egovframework.com.edoc.clsf.domain.model.DocumentClassificationVO">
		<result property="no" column="doc_clsf_no"/>
		<result property="divCode" column="doc_clsf_se_cd"/>
		<result property="name" column="doc_clsf_nm"/>
		<result property="parentNo" column="up_doc_clsf_no"/>
		<result property="includingPrivacy" column="prvc_incl_yn"/>
		<result property="use" column="use_en"/>
		<result property="created" column="reg_ymd"/>
		<result property="updated" column="mdfcn_ymd"/>
		<result property="author" column="rgtr_id"/>
		<result property="updateAuthor" column="mdfr_id"/>
	</resultMap>
	
	<sql id="fields">
		dc.doc_clsf_no, 
		dc.doc_clsf_se_cd, 
		dc.doc_clsf_nm, 
		dc.up_doc_clsf_no, 
		dc.prvc_incl_yn, 
		dc.use_en, 
		dc.reg_ymd, 
		dc.rgtr_id, 
		dc.mdfcn_ymd, 
		dc.mdfr_id,
		dcnm.doc_lclsf_nm,
		dcnm.doc_mclsf_nm,
		dcnm.doc_sclsf_nm
	</sql>
	
	<sql id="fromTables">
		tb_dr_m_doc_clsf AS dc
		LEFT JOIN 
		(WITH RECURSIVE cte(doc_clsf_no, doc_clsf_se_cd, up_doc_clsf_no, doc_clsf_nm_arr) AS (
			SELECT t.doc_clsf_no, t.doc_clsf_se_cd, t.up_doc_clsf_no, CAST(ARRAY[t.doc_clsf_nm] AS text[]) AS doc_clsf_nm_arr FROM tb_dr_m_doc_clsf AS t 
			UNION ALL
			SELECT cte.doc_clsf_no, p.doc_clsf_se_cd, p.up_doc_clsf_no, cte.doc_clsf_nm_arr || p.doc_clsf_nm FROM tb_dr_m_doc_clsf AS p JOIN cte ON p.doc_clsf_no=cte.up_doc_clsf_no
			) 
		SELECT cte.doc_clsf_no, doc_clsf_nm_arr[1] AS doc_lclsf_nm, doc_clsf_nm_arr[2] AS doc_mclsf_nm, doc_clsf_nm_arr[3] AS doc_sclsf_nm FROM cte WHERE cte.doc_clsf_se_cd='L'
		) AS dcnm ON dc.doc_clsf_no=dcnm.doc_clsf_no
	</sql>


	<select id="select" resultType="egovframework.com.edoc.clsf.domain.model.DocumentClassificationVO">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_no = #{no}
 		
 	</select>

	<select id="selectListByDivCode" resultType="egovframework.com.edoc.clsf.domain.model.DocumentClassificationVO">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.doc_clsf_se_cd = #{divCode}
 		
 	</select>
 	

 	<select id="selectListByParentNo" resultType="egovframework.com.edoc.clsf.domain.model.DocumentClassificationVO">
		SELECT
			<include refid="fields"/>
		FROM
			<include refid="fromTables"/>
		WHERE
			dc.up_doc_clsf_no = #{parentNo}
 	</select> 	
</mapper>